#!/bin/bash
# kubctl-0x03 - Perform rolling update on blue deployment

set -euo pipefail

DEPLOYMENT=messaging-app-blue
SERVICE=messaging-app
NAMESPACE=default

echo ">>> Applying updated deployment (rolling update)..."
kubectl apply -n "$NAMESPACE" -f blue_deployment.yaml

echo ">>> Monitoring rollout status..."
kubectl rollout status deployment/"$DEPLOYMENT" -n "$NAMESPACE"

echo ">>> Port-forwarding service to localhost:8000..."
kubectl port-forward service/$SERVICE 8000:8000 -n $NAMESPACE &
PF_PID=$!
sleep 5

echo ">>> Testing app availability with curl during update..."
for i in {1..20}; do
  if curl -s http://127.0.0.1:8000/ >/dev/null; then
    echo "[$i] ✅ App responded"
  else
    echo "[$i] ❌ App did NOT respond (downtime!)"
  fi
  sleep 1
done

kill $PF_PID

echo ">>> Verifying pods after rollout..."
kubectl get pods -n "$NAMESPACE" -l app=messaging-app,version=blue -o wide

echo ">>> Rolling update complete ✅"
